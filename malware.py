import hashlib
import requests

def file_hash(filepath: str, hash_obj, block_size: int = 8192) -> str:
    hash_obj = hash_obj
    with open(filepath, 'rb') as f:
        for chunk in iter(lambda: f.read(block_size), b''):
            hash_obj.update(chunk)
    return hash_obj.hexdigest()

def compute_hashes(filepath: str) -> dict:
    return {
        'md5': file_hash(filepath, hashlib.md5()),
        'sha1': file_hash(filepath, hashlib.sha1()),
        'sha256': file_hash(filepath, hashlib.sha256())
    }

def optional_virustotal_check(api_key: str, sha256_hash: str):
    """
    Query VirusTotal v3 file analysis by SHA256.
    If you want to use it: set environment variable VIRUSTOTAL_API_KEY.
    """
    if not api_key:
        return {'error': 'No API key provided'}
    url = f'https://www.virustotal.com/api/v3/files/{sha256_hash}'
    headers = {'x-apikey': api_key}
    r = requests.get(url, headers=headers, timeout=10)
    if r.status_code == 200:
        return r.json()
    return {'error': f'HTTP {r.status_code}', 'text': r.text}
